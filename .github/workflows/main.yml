name: AlwaysOn CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORG: ${{ secrets.SONAR_ORG }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: App Test
        run: |
          echo "Running app tests..."
          # Add your test command here, e.g. npm test or pytest
          echo "Tests passed!"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        with:
          projectKey: ${{ env.SONAR_PROJECT_KEY }}
          organization: ${{ env.SONAR_ORG }}
          token: ${{ env.SONAR_TOKEN }}

      - name: Docker Login
        run: echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin

      - name: Build Docker image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          docker build -t $DOCKERHUB_USERNAME/alwayson-app:$IMAGE_TAG ./docker
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push Docker image
        run: docker push $DOCKERHUB_USERNAME/alwayson-app:${{ env.IMAGE_TAG }}

      - name: Deploy to Blue or Green
        run: |
          if [ "$GITHUB_REF" == "refs/heads/main" ]; then
            bash ./scripts/deploy-blue.sh $DOCKERHUB_USERNAME/alwayson-app:${{ env.IMAGE_TAG }}
          else
            bash ./scripts/deploy-green.sh $DOCKERHUB_USERNAME/alwayson-app:${{ env.IMAGE_TAG }}
          fi

      - name: Health check
        run: curl -f http://localhost:8081 || curl -f http://localhost:8082

      - name: Rollback on failure
        if: failure()
        run: bash ./scripts/rollback.sh blue
